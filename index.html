<!DOCTYPE html>
<html lang="es">

<head>
    <link rel="manifest" href="./manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RadioLog Pro v2.4 | Secure & Merge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./auth.js"></script> <!-- EXTERNAL AUTH -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@400;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --main-dark: #0f172a;
            --accent: #0ea5e9;
            --tx-ok: #10b981;
            --rx-only: #ef4444;
        }

        body {
            background-color: #f0f4f8;
            /* Technical Grid Pattern Background */
            background-image: 
                linear-gradient(rgba(148, 163, 184, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            body {
                flex-direction: row;
            }
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Sidebar Transitions */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }

        /* Mobile Overlay */
        #mobile-overlay {
            transition: opacity 0.3s ease-in-out;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        .logo-area {
            padding: 30px;
            background: #ffffff; 
            border-bottom: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        
        /* Subtle shine effect on logo area */
        .logo-area::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), transparent);
        }

        @keyframes radio-ping {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            100% {
                transform: scale(2.2);
                opacity: 0;
            }
        }

        .radio-wave {
            transform-origin: 50% 30%;
            animation: radio-ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        .wave-2 {
            animation-delay: 0.6s;
        }

        .wave-3 {
            animation-delay: 1.2s;
        }

        .nav-link {
            color: #475569; /* Slate 600 - Darker text for light bg */
            padding: 15px 30px;
            font-weight: 800;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            border-right: 3px solid transparent;
        }

        .nav-link:hover {
            color: var(--accent);
            background: #f0f9ff; /* Sky 50 */
        }

        .nav-link.active {
            color: var(--accent);
            background: #e0f2fe; /* Sky 100 */
            border-right-color: var(--accent);
        }

        .nav-link i {
            width: 24px;
            text-align: center;
            font-size: 1.1em;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            scroll-behavior: smooth;
            position: relative;
        }

        @media (min-width: 768px) {
            main {
                padding: 40px;
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: slideUp 0.2s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-tactical {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        /* --- NEW DARK TACTICAL CARD (For QSO Form) --- */
        .card-tactical-dark {
            background: linear-gradient(160deg, #1e293b, #0f172a); /* Dark Slate Gradient */
            border-radius: 12px;
            border: 1px solid #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            position: relative;
        }
        
        /* Decorative screw heads for tactical look */
        .card-tactical-dark::before, .card-tactical-dark::after {
            content: '+';
            position: absolute;
            color: #475569;
            font-family: monospace;
            font-size: 20px;
            pointer-events: none;
        }
        .card-tactical-dark::before { top: 10px; left: 15px; }
        .card-tactical-dark::after { top: 10px; right: 15px; }

        .card-tactical-dark label {
            color: #94a3b8; /* Slate 400 */
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .card-tactical-dark input,
        .card-tactical-dark select,
        .card-tactical-dark textarea {
            background-color: #334155; /* Slate 700 */
            border: 2px solid #475569;
            color: #f8fafc; /* White text */
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);
        }

        .card-tactical-dark input::placeholder,
        .card-tactical-dark textarea::placeholder {
            color: #64748b;
        }

        .card-tactical-dark input:focus,
        .card-tactical-dark select:focus,
        .card-tactical-dark textarea:focus {
            border-color: var(--accent);
            background-color: #1e293b; /* Slate 800 */
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .card-header {
            padding: 14px 24px;
            font-weight: 800;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            letter-spacing: 0.05em;
        }

        .badge-status {
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 800;
            font-size: 0.65rem;
            border: 1px solid;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .status-tx {
            border-color: var(--tx-ok);
            color: var(--tx-ok);
            background: #f0fdf4;
        }

        .status-rx {
            border-color: var(--rx-only);
            color: var(--rx-only);
            background: #fef2f2;
        }

        .status-unlocked {
            border-color: #8b5cf6;
            color: #8b5cf6;
            background: #f5f3ff;
        }

        /* Default Light Inputs (for other areas) */
        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-weight: 600;
            outline: none;
            transition: 0.2s;
            font-size: 0.9rem;
            color: #334155;
            background-color: #f8fafc;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            font-weight: 800;
            text-transform: uppercase;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3);
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn-action {
             padding: 8px;
             border-radius: 6px;
             transition: 0.2s;
             cursor: pointer;
             font-size: 0.85rem;
        }
        .btn-action:hover {
            background-color: #f1f5f9;
        }

        .table-tactical {
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
        }

        .table-tactical thead th {
            background: #f8fafc;
            padding: 14px 24px;
            color: #64748b;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.7rem;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            letter-spacing: 0.05em;
            /* Sticky Header for vertical scroll */
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .table-tactical td {
            padding: 14px 24px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .table-tactical tr:hover td {
            background-color: #f8fafc;
        }
        
        /* Modal Styles */
        .modal-overlay {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }

        /* --- ANIMATIONS & GRAPHICS --- */
        
        /* Spectrum Analyzer Bars (Old) -> Replaced by SVG widget but kept for legacy just in case */
        .spectrum-container {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 20px;
            opacity: 0.8;
        }
        
        .spectrum-bar {
            width: 4px;
            background-color: #0ea5e9;
            border-radius: 2px 2px 0 0;
            animation: spectrum-bounce 1s infinite ease-in-out;
        }
        
        @keyframes spectrum-bounce {
            0%, 100% { height: 20%; opacity: 0.5; }
            50% { height: 100%; opacity: 1; }
        }
        
        /* Oscilloscope Line in Logo Area */
        .scope-line {
            width: 100%;
            height: 2px;
            background: #cbd5e1;
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }
        .scope-dot {
            position: absolute;
            width: 40px;
            height: 100%;
            background: linear-gradient(90deg, transparent, #0ea5e9, transparent);
            left: -40px;
            animation: scope-scan 2s linear infinite;
        }
        @keyframes scope-scan {
            0% { left: -40px; }
            100% { left: 100%; }
        }

        /* SDR Widget Styles */
        .sdr-placeholder {
            width: 100%; 
            max-width: 260px;
            min-width: 180px;
            height: 64px; 
            display: inline-block;
            vertical-align: middle;
            margin-left: 0;
            border: 2px solid #334155;
            border-radius: 6px;
            background: #000;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.15);
            position: relative;
            overflow: hidden;
        }

    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>

<body>

    <!-- SECURITY OVERLAY -->
    <div id="login-overlay"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-white/90 backdrop-blur-md transition-all duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border border-slate-100">
            <div class="mb-6 flex justify-center text-sky-500 text-5xl">
                <i class="fas fa-fingerprint"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-2 uppercase italic tracking-tighter">Acceso Restringido
            </h2>
            <div class="w-12 h-1 bg-sky-500 mx-auto mb-6 rounded-full"></div>
            <p class="text-slate-500 mb-6 text-xs font-bold uppercase tracking-widest">Autenticación Requerida</p>
            <input type="password" id="login-pass"
                class="w-full p-4 border-2 border-slate-200 rounded-xl mb-4 font-black text-center text-slate-800 focus:border-sky-500 outline-none text-xl tracking-widest placeholder:text-slate-300 transition-all"
                placeholder="••••••••" onkeyup="if(event.key === 'Enter') doLogin()">
            <button onclick="doLogin()"
                class="w-full bg-slate-900 text-white font-black py-4 rounded-xl hover:bg-sky-600 transition transform active:scale-95 uppercase tracking-wide text-sm shadow-xl shadow-slate-200">Desbloquear
                Terminal</button>
            <p id="login-msg" class="text-rose-500 text-xs font-black mt-4 h-4 uppercase tracking-wide"></p>
        </div>
    </div>

    <!-- RESOURCE EDIT MODAL -->
    <div id="resource-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border-t-4 border-sky-500 ring-1 ring-black/5">
            <div class="bg-slate-50 px-6 py-4 flex justify-between items-center border-b border-slate-100">
                <h3 id="modal-title" class="font-black text-slate-800 uppercase italic tracking-tight text-lg">Editar Recurso</h3>
                <button onclick="closeResourceModal()" class="text-slate-400 hover:text-rose-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-rose-50">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <form id="resource-form" class="p-6 space-y-5">
                <input type="hidden" id="res-id">
                <input type="hidden" id="res-type">
                <div id="modal-fields" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <!-- Dynamic Fields Injected Here -->
                </div>
                <div class="flex gap-3 pt-4 border-t border-slate-50 mt-4">
                    <button type="button" onclick="closeResourceModal()" class="flex-1 bg-white border-2 border-slate-200 text-slate-600 font-bold py-3 rounded-lg uppercase text-xs hover:bg-slate-50 hover:border-slate-300 transition-all">Cancelar</button>
                    <button type="submit" class="flex-1 bg-sky-500 text-white font-bold py-3 rounded-lg uppercase text-xs hover:bg-sky-600 shadow-lg shadow-sky-100 transition-all">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MOBILE HEADER -->
    <div class="md:hidden flex justify-between items-center p-4 bg-white text-slate-800 z-40 shadow-sm border-b border-slate-200">
        <div class="flex items-center gap-2">
            <i class="fas fa-broadcast-tower text-sky-500 text-xl"></i>
            <span class="font-black italic tracking-tighter text-lg">RADIOLOG <span class="text-sky-500">PRO</span></span>
        </div>
        <button onclick="toggleMenu()" class="text-slate-600 hover:text-sky-500 focus:outline-none transition-colors">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>

    <!-- MOBILE OVERLAY -->
    <div id="mobile-overlay" onclick="toggleMenu()" class="fixed inset-0 z-40 hidden md:hidden"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar"
        class="sidebar fixed inset-y-0 left-0 transform -translate-x-full md:translate-x-0 md:static md:flex flex-col w-72 bg-white text-slate-800 border-r border-slate-200 shadow-xl shadow-slate-200/50 overflow-y-auto z-50">

        <div class="logo-area flex flex-col items-start relative">
            <!-- Mobile Close Button -->
            <button onclick="toggleMenu()" class="md:hidden absolute top-4 right-4 text-slate-400 hover:text-rose-500">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="relative w-16 h-16 mb-2">
                <!-- Updated SVG colors for Light Theme -->
                <svg viewBox="0 0 100 100" class="w-full h-full text-sky-500 overflow-visible">
                    <circle cx="50" cy="30" r="8" class="radio-wave" fill="none" stroke="currentColor"
                        stroke-width="2" />
                    <circle cx="50" cy="30" r="8" class="radio-wave wave-2" fill="none" stroke="currentColor"
                        stroke-width="1.5" />
                    <circle cx="50" cy="30" r="8" class="radio-wave wave-3" fill="none" stroke="currentColor"
                        stroke-width="1" />
                    <!-- Changed stroke from white to slate-800 (#1e293b) -->
                    <path d="M50 30 L50 85" stroke="#1e293b" stroke-width="4" stroke-linecap="round" />
                    <path d="M35 50 L50 45 L65 50" fill="none" stroke="#1e293b" stroke-width="2" stroke-linecap="round" />
                    <path d="M40 65 L50 60 L60 65" fill="none" stroke="#1e293b" stroke-width="2" stroke-linecap="round" />
                    <rect x="30" y="80" width="40" height="12" rx="2" fill="currentColor" />
                    <!-- Changed circle fill from white to slate-800 -->
                    <circle cx="50" cy="30" r="4" fill="#1e293b" />
                </svg>

            </div>
            <h1 class="text-xl font-black tracking-tighter italic uppercase text-slate-900">RADIOLOG <span
                    class="text-sky-500">PRO</span> <span class="text-xl font-black 100 text-slate-400">v2.4</span></h1>
            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">by Kepa iNKuBo</p>
            
            <!-- Oscilloscope Line -->
            <div class="scope-line">
                <div class="scope-dot"></div>
            </div>

            <div id="sync-indicator"
                class="mt-4 text-[9px] font-black bg-slate-100 text-slate-500 px-3 py-1 rounded-full inline-block uppercase tracking-widest transition-colors border border-slate-200">
                Sync: Initializing</div>
        </div>

        <nav class="mt-6 flex-1 px-4 space-y-1">
            <button onclick="switchTab('logbook')" id="btn-logbook" class="nav-link rounded-lg active"><i
                    class="fas fa-terminal"></i> Logbook</button>
            <button onclick="switchTab('repeaters')" id="btn-repeaters" class="nav-link rounded-lg"><i
                    class="fas fa-tower-broadcast"></i> Repetidores</button>
            <button onclick="switchTab('pmr')" id="btn-pmr" class="nav-link rounded-lg"><i class="fas fa-walkie-talkie"></i>
                Canales PMR446</button>
            <button onclick="switchTab('emerg')" id="btn-emerg" class="nav-link rounded-lg"><i class="fas fa-life-ring"></i>
                Emergencias</button>
            <button onclick="switchTab('fm')" id="btn-fm" class="nav-link rounded-lg"><i class="fas fa-radio"></i> FM
                Comercial</button>
            <button onclick="switchTab('hardware')" id="btn-hardware" class="nav-link rounded-lg"><i
                    class="fas fa-microchip"></i> Espectro H8</button>
            <button onclick="switchTab('sync')" id="btn-sync" class="nav-link rounded-lg"><i class="fas fa-cloud-arrow-up"></i>
                Sincronización</button>
        </nav>

        <div
            class="p-6 text-[9px] font-bold text-slate-400 border-t border-slate-100 text-center uppercase tracking-tighter pb-8 md:pb-6 bg-slate-50">
            <div class="mb-1"><i class="fas fa-satellite-dish text-sky-400"></i></div>
            Hardware Status: 65-600 MHz
        </div>
    </aside>

    <main>
        <!-- TAB: LOGBOOK -->
        <div id="tab-logbook" class="tab-content active">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
                <div>
                    <h2
                        class="text-3xl md:text-4xl font-black italic uppercase text-slate-800 tracking-tighter relative z-10 flex items-center gap-3 flex-wrap">
                        <span><span class="text-sky-500">Terminal</span> Logbook</span>
                        <div class="sdr-placeholder"></div>
                        <span class="absolute -bottom-2 left-0 w-12 h-1.5 bg-sky-500 rounded-full"></span>
                    </h2>
                    <div class="flex gap-2 mt-4">
                        <label
                            class="text-[10px] bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 font-black px-4 py-2 rounded-lg uppercase transition-all cursor-pointer inline-flex items-center shadow-sm">
                            <i class="fas fa-file-import mr-2 text-sky-500"></i> Importar
                            <input type="file" id="import-json" class="hidden" accept=".json">
                        </label>
                        <button onclick="exportJSON()"
                            class="text-[10px] bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 font-black px-4 py-2 rounded-lg uppercase transition-all shadow-sm"><i
                                class="fas fa-file-export mr-2 text-emerald-500"></i> Exportar</button>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <!-- SPECTRUM ANIMATION -->
                    <div class="spectrum-container mb-2">
                        <div class="spectrum-bar" style="height: 40%; animation-delay: 0s;"></div>
                        <div class="spectrum-bar" style="height: 70%; animation-delay: 0.1s;"></div>
                        <div class="spectrum-bar" style="height: 100%; animation-delay: 0.2s;"></div>
                        <div class="spectrum-bar" style="height: 60%; animation-delay: 0.3s;"></div>
                        <div class="spectrum-bar" style="height: 30%; animation-delay: 0.4s;"></div>
                        <div class="spectrum-bar" style="height: 80%; animation-delay: 0.5s;"></div>
                        <div class="spectrum-bar" style="height: 50%; animation-delay: 0.6s;"></div>
                    </div>
                    <span id="log-count"
                        class="bg-slate-900 text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase w-full md:w-auto text-center shadow-lg shadow-slate-200 tracking-wider">Cargando...</span>
                </div>
            </div>

            <!-- DARK TACTICAL FORM CARD -->
            <div class="card-tactical-dark p-6 md:p-8 transition-colors" id="form-card">
                <div class="absolute top-0 right-0 p-2 opacity-10">
                    <i class="fas fa-broadcast-tower text-6xl text-white"></i>
                </div>
                <form id="qso-form" class="grid grid-cols-1 md:grid-cols-12 gap-5 relative z-10">
                    <div class="md:col-span-4">
                        <label class="text-[10px] font-extrabold uppercase mb-2 block tracking-wide"><i class="fas fa-id-card mr-1"></i> Indicativo (Callsign)</label>
                        <input type="text" id="callsign" placeholder="EA2XXX" class="uppercase mono text-lg" required>
                    </div>
                    <div class="grid grid-cols-2 gap-5 md:col-span-2">
                        <div>
                            <label class="text-[10px] font-extrabold uppercase mb-2 block tracking-wide"><i class="fas fa-signal mr-1"></i> RST</label>
                            <input type="text" id="rst" value="59" class="mono text-center text-lg">
                        </div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="text-[10px] font-extrabold uppercase mb-2 block tracking-wide"><i class="fas fa-list-ul mr-1"></i> Banda / Modo</label>
                        <select id="band" class="h-[50px]">
                            <option>2m VHF (FM)</option>
                            <option>70cm UHF (FM)</option>
                            <option>HF / DX</option>
                        </select>
                    </div>
                    <div class="md:col-span-3 flex items-end gap-2">
                        <button type="submit" id="submit-btn"
                            class="btn-primary w-full shadow-lg shadow-sky-900/50 disabled:opacity-50 h-[50px] text-sm tracking-widest border border-sky-400">Registrar QSO</button>
                        <button type="button" id="cancel-edit-btn" onclick="cancelEdit()"
                            class="hidden bg-slate-700 border border-slate-600 text-slate-300 px-4 h-[50px] rounded-lg font-bold hover:bg-rose-900/50 hover:text-rose-400 hover:border-rose-500 transition-colors"><i
                                class="fas fa-times text-lg"></i></button>
                    </div>
                    <div class="md:col-span-12">
                        <textarea id="comment" rows="2"
                            placeholder="Notas adicionales: Ubicación, Operador, Clima..."></textarea>
                    </div>
                </form>
            </div>

            <!-- SEARCH BAR -->
            <div class="mb-8 relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fas fa-search text-slate-400 group-focus-within:text-sky-500 transition-colors"></i>
                </div>
                <input type="text" id="search-input" onkeyup="renderAll()"
                    placeholder="BUSCAR EN LOGBOOK (INDICATIVO, FECHA...)"
                    class="w-full pl-12 p-4 rounded-xl border-2 border-slate-200 bg-white font-bold text-slate-700 uppercase focus:border-sky-500 focus:outline-none transition-all shadow-sm placeholder:text-slate-300">
            </div>

            <div id="logs-container" class="space-y-4"></div>
        </div>

        <!-- TAB: REPETIDORES -->
        <div id="tab-repeaters" class="tab-content">
            <h2 class="text-3xl md:text-4xl font-black italic uppercase text-slate-800 tracking-tighter mb-8 flex items-center gap-3 flex-wrap">
                <span>Repetidores <span class="text-sky-600">Bizkaia</span></span>
                <div class="sdr-placeholder"></div>
            </h2>
            <div class="card-tactical border-0">
                <div class="card-header bg-sky-600 shadow-md">
                    <div class="flex items-center gap-3"><i class="fas fa-mountain text-sky-200"></i> Infraestructura de Red Local</div>
                    <button onclick="openResourceModal('repeaters')" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-md text-[10px] uppercase font-bold backdrop-blur-sm transition-all border border-white/10"><i class="fas fa-plus mr-1"></i> Añadir</button>
                </div>
                <div class="overflow-auto max-h-[60vh] border-t border-slate-200">
                    <table class="table-tactical text-left">
                        <thead>
                            <tr>
                                <th>ID / Ubicación</th>
                                <th>RX (MHz)</th>
                                <th>TX (MHz)</th>
                                <th>Offset</th>
                                <th>Tono</th>
                                <th>Acceso</th>
                                <th class="text-right">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="table-repeaters"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: PMR446 -->
        <div id="tab-pmr" class="tab-content">
            <h2 class="text-3xl md:text-4xl font-black italic uppercase text-slate-800 tracking-tighter mb-8 flex items-center gap-3 flex-wrap">
                <span>Canales <span class="text-emerald-600">PMR446</span></span>
                <div class="sdr-placeholder"></div>
            </h2>
            <div class="card-tactical border-0">
                <div class="card-header bg-emerald-600 shadow-md">
                    <div class="flex items-center gap-3"><i class="fas fa-walkie-talkie text-emerald-200"></i> Uso Libre - NFM Modulación</div>
                    <button onclick="openResourceModal('pmr')" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-md text-[10px] uppercase font-bold backdrop-blur-sm transition-all border border-white/10"><i class="fas fa-plus mr-1"></i> Añadir</button>
                </div>
                <div class="overflow-auto max-h-[60vh] border-t border-slate-200">
                    <table class="table-tactical text-left">
                        <thead>
                            <tr>
                                <th>Canal</th>
                                <th>Frecuencia (MHz)</th>
                                <th>Modo</th>
                                <th>Potencia</th>
                                <th>Uso</th>
                                <th class="text-right">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="table-pmr"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: EMERG & AIRE -->
        <div id="tab-emerg" class="tab-content">
            <h2 class="text-3xl md:text-4xl font-black italic uppercase text-slate-800 tracking-tighter mb-8 flex items-center gap-3 flex-wrap">
                <span>Frecuencias <span class="text-rose-500">Críticas</span></span>
                <div class="sdr-placeholder"></div>
            </h2>
            <div class="card-tactical mb-8 border-0">
                <div class="card-header bg-rose-600 shadow-md">
                    <div class="flex items-center gap-3"><i class="fas fa-life-ring text-rose-200"></i> Red de Emergencias & Auxilio</div>
                    <button onclick="openResourceModal('emerg')" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-md text-[10px] uppercase font-bold backdrop-blur-sm transition-all border border-white/10"><i class="fas fa-plus mr-1"></i> Añadir</button>
                </div>
                <div class="overflow-auto max-h-[60vh] border-t border-slate-200">
                    <table class="table-tactical text-left">
                        <thead>
                            <tr>
                                <th>Servicio</th>
                                <th>Frecuencia</th>
                                <th>Modo</th>
                                <th>Notas</th>
                                <th>TX</th>
                                <th class="text-right">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="table-emerg"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card-tactical border-0">
                <div class="card-header bg-slate-700 shadow-md">
                     <div class="flex items-center gap-3"><i class="fas fa-plane text-slate-300"></i> Banda Aérea</div>
                     <button onclick="openResourceModal('emerg', 'AIR')" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-md text-[10px] uppercase font-bold backdrop-blur-sm transition-all border border-white/10"><i class="fas fa-plus mr-1"></i> Añadir</button>
                </div>
                <div class="overflow-auto max-h-[60vh] border-t border-slate-200">
                    <table class="table-tactical text-left">
                        <thead>
                            <tr>
                                <th>Servicio</th>
                                <th>Freq (MHz)</th>
                                <th>Modo</th>
                                <th>Función</th>
                                <th class="text-right">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="table-air"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: FM -->
        <div id="tab-fm" class="tab-content">
            <h2 class="text-3xl md:text-4xl font-black italic uppercase text-slate-800 tracking-tighter mb-8 flex items-center gap-3 flex-wrap">
                <span>FM <span class="text-indigo-600">Comercial</span></span>
                <div class="sdr-placeholder"></div>
            </h2>
            <div class="card-tactical border-0">
                <div class="card-header bg-indigo-600 shadow-md">
                    <div class="flex items-center gap-3"><i class="fas fa-radio text-indigo-200"></i> Estaciones Local / Regional</div>
                    <button onclick="openResourceModal('fm')" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-md text-[10px] uppercase font-bold backdrop-blur-sm transition-all border border-white/10"><i class="fas fa-plus mr-1"></i> Añadir</button>
                </div>
                <div class="overflow-auto max-h-[60vh] border-t border-slate-200">
                    <table class="table-tactical text-left">
                        <thead>
                            <tr>
                                <th>Emisora</th>
                                <th>Freq (MHz)</th>
                                <th>Zona</th>
                                <th>Señal Est.</th>
                                <th class="text-right">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="table-fm"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: HARDWARE -->
        <div id="tab-hardware" class="tab-content">
            <h2 class="text-3xl md:text-4xl font-black italic uppercase text-slate-800 tracking-tighter mb-8 flex items-center gap-3 flex-wrap">
                <span>Espectro <span class="text-slate-900">Tidradio H8</span></span>
                <div class="sdr-placeholder"></div>
            </h2>
            <div class="card-tactical border-0">
                <div class="card-header bg-slate-900 text-sky-400 shadow-md">
                    <div class="flex items-center gap-3"><i class="fas fa-wave-square"></i> IARU Región 1</div>
                    <button onclick="openResourceModal('hardware')" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-md text-[10px] uppercase font-bold backdrop-blur-sm transition-all border border-white/10"><i class="fas fa-plus mr-1"></i> Añadir</button>
                </div>
                <div class="overflow-auto max-h-[60vh] border-t border-slate-200">
                    <table class="table-tactical text-left">
                        <thead>
                            <tr>
                                <th>Rango (MHz)</th>
                                <th>Sub-Banda</th>
                                <th>Uso Exclusivo / Notas</th>
                                <th>Modo</th>
                                <th>TX</th>
                                <th class="text-right">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="table-h8"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: SYNC -->
        <div id="tab-sync" class="tab-content max-w-4xl mx-auto space-y-8">
            <h2 class="text-3xl md:text-4xl font-black italic uppercase text-center mb-8 text-slate-800 tracking-tighter flex items-center justify-center gap-3 flex-wrap">
                <span>Data Hub & <span class="text-sky-500">Cloud Sync</span></span>
                <div class="sdr-placeholder"></div>
            </h2>

            <div
                class="bg-slate-900 text-green-400 p-5 rounded-xl mono text-xs border-l-4 border-green-500 shadow-2xl overflow-x-auto ring-4 ring-slate-100">
                <div class="font-bold border-b border-slate-700 pb-2 mb-3 flex justify-between">
                    <span>DEBUG CONSOLE</span>
                    <span class="animate-pulse">●</span>
                </div>
                <div id="console-output" class="h-32 opacity-90">> System Ready. Waiting for input...</div>
            </div>

            <!-- MANUAL CONFIG PANEL -->
            <div class="card-tactical p-8 border-l-4 border-amber-500 bg-amber-50/50">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-600">
                        <i class="fas fa-cogs text-xl"></i>
                    </div>
                    <h3 class="font-black uppercase text-amber-900 text-lg">Configuración de Conexión</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] font-bold uppercase text-amber-800 mb-2 block">Supabase Project URL</label>
                        <input type="text" id="cfg-url" placeholder="https://svcakitmimdhltwcmadd.supabase.co"
                            class="text-xs bg-white border-amber-200 focus:border-amber-500 focus:ring-amber-200">
                        <p class="text-[9px] text-amber-700 mt-2 font-medium">Detectado ID: svcakitmimdhltwcmadd</p>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold uppercase text-amber-800 mb-2 block">Supabase API Key</label>
                        <input type="password" id="cfg-key" placeholder="sb_publishable..." class="text-xs bg-white border-amber-200 focus:border-amber-500 focus:ring-amber-200">
                        <p class="text-[9px] text-amber-700 mt-2 font-medium">Usar clave proporcionada (Key)</p>
                    </div>
                    <div class="md:col-span-2 text-right pt-2">
                        <button onclick="saveConfig()"
                            class="bg-amber-500 text-white px-6 py-3 rounded-lg text-xs font-black uppercase hover:bg-amber-600 shadow-lg shadow-amber-200 transition-all transform active:scale-95">Guardar
                            y Conectar</button>
                    </div>
                </div>
            </div>

            <div class="card-tactical p-8 bg-indigo-50/50 border-l-4 border-indigo-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                        <i class="fas fa-sync text-xl"></i>
                    </div>
                    <h3 class="font-black uppercase text-indigo-900 text-lg">Restauración Inteligente</h3>
                </div>
                <p class="text-sm text-indigo-700/80 mb-6 font-medium leading-relaxed">Usa este botón para rellenar la base de datos en la nube con los datos originales (Repeaters, FM, etc.) si faltan. <strong class="text-indigo-900">No borrará tus datos actuales</strong>, solo añadirá los que no existan.</p>
                <button onclick="uploadMissingSeedData()" class="bg-indigo-600 text-white px-6 py-4 rounded-lg text-xs font-black uppercase hover:bg-indigo-700 w-full shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2"><i class="fas fa-cloud-upload-alt text-lg"></i> Fusionar Datos Semilla (Smart Merge)</button>
            </div>

            <!-- SQL INSTALL HELPER -->
            <div class="card-tactical p-8 bg-slate-50 border-l-4 border-slate-400">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600">
                        <i class="fas fa-database text-xl"></i>
                    </div>
                    <h3 class="font-black uppercase text-slate-800 text-lg">Instalación de Base de Datos</h3>
                </div>
                <p class="text-xs text-slate-500 mb-6 font-medium">Si las tablas no existen en Supabase, pulsa el botón para copiar los comandos SQL.</p>
                <button onclick="showInstallSQL()" class="bg-slate-700 text-white px-6 py-3 rounded-lg text-xs font-black uppercase hover:bg-slate-800 w-full shadow-lg shadow-slate-200 transition-all"><i class="fas fa-copy mr-2"></i> Ver Comandos SQL de Instalación</button>
                <div id="sql-box" class="hidden mt-6">
                    <textarea readonly id="sql-area" class="w-full h-48 bg-slate-900 text-emerald-400 text-[10px] mono p-4 rounded-lg shadow-inner border border-slate-700 focus:outline-none" onclick="this.select()"></textarea>
                    <p class="text-[9px] text-center text-slate-400 mt-2 uppercase font-bold">Copia, pega en Supabase SQL Editor y ejecuta.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div
                    class="card-tactical p-8 text-center space-y-4 border-2 border-transparent hover:border-sky-200 hover:shadow-xl transition-all group cursor-default">
                    <div class="w-16 h-16 bg-sky-50 rounded-full flex items-center justify-center mx-auto group-hover:scale-110 transition-transform">
                        <i class="fas fa-cloud text-sky-500 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-black uppercase italic text-slate-800">Estado de Supabase</h3>
                    <p id="cloud-status-text" class="text-[10px] text-slate-400 font-bold uppercase bg-slate-100 py-1 px-3 rounded-full inline-block">Verificando
                        conexión...</p>
                    <button onclick="fetchLogs()" class="btn-primary w-full text-[10px] mt-4">Forzar Sincronización</button>
                </div>
                <div
                    class="card-tactical p-8 text-center space-y-4 border-2 border-transparent hover:border-emerald-200 hover:shadow-xl transition-all group cursor-default bg-white">
                    <div class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center mx-auto group-hover:scale-110 transition-transform">
                        <i class="fas fa-file-csv text-emerald-500 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-black uppercase italic text-slate-800">Export H8 CSV</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Base de Datos Completa</p>
                    <button onclick="downloadCSV()"
                        class="bg-emerald-500 text-white font-black py-4 rounded-lg w-full text-[10px] uppercase shadow-lg shadow-emerald-100 hover:bg-emerald-600 transition-all">Descargar
                        MASTER_H8.csv</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- UI CORE ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
            window.scrollTo(0, 0);

            const sidebar = document.getElementById('sidebar');
            if (sidebar && !sidebar.classList.contains('-translate-x-full')) {
                toggleMenu();
            }
        }

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');

            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function sysLog(msg, color = 'text-green-500') {
            const out = document.getElementById('console-output');
            if (out) {
                out.innerHTML += `<br><span class="${color}">> ${new Date().toLocaleTimeString()}: ${msg}</span>`;
                out.scrollTop = out.scrollHeight;
            }
        }

        // --- AUTHENTICATION (SECURE WRAPPER) ---
        function doLogin() {
            const passField = document.getElementById('login-pass');
            const pass = passField.value.trim(); // Trim added
            
            // Check if auth system loaded
            if (typeof window.checkPassword !== 'function') {
                document.getElementById('login-msg').innerText = "ERROR: auth.js no cargado";
                return;
            }

            if (window.checkPassword(pass)) {
                document.getElementById('login-overlay').classList.add('opacity-0', 'pointer-events-none');
                if(window.setSessionActive) window.setSessionActive();
            } else {
                document.getElementById('login-msg').innerText = "ACCESO DENEGADO";
                passField.value = ''; // Clear input
                passField.focus();
            }
        }

        function checkAuthSync(action) {
            if (window.isSessionActive && window.isSessionActive()) return true;
            
            const p = prompt(`SEGURIDAD: Contraseña para ${action}:`);
            if (window.checkPassword && window.checkPassword(p)) {
                 if(window.setSessionActive) window.setSessionActive();
                 return true;
            }
            alert("❌ Contraseña incorrecta");
            return false;
        }

        // --- SUPABASE CONFIG ---
        const DEFAULT_URL = 'https://svcakitmimdhltwcmadd.supabase.co';
        const DEFAULT_KEY = 'sb_publishable_uR_yVZpJ2wOkUD0bihyGBg_E__lJACJ';

        let SB_URL = localStorage.getItem('sb_url') || DEFAULT_URL;
        let SB_KEY = localStorage.getItem('sb_key') || DEFAULT_KEY;

        document.getElementById('cfg-url').value = SB_URL;
        document.getElementById('cfg-key').value = SB_KEY;

        let supabaseClient = null;

        // --- GLOBAL STATE ---
        let logs = [];
        let editingId = null;

        // --- HELPER FUNCTIONS ---
        function updateStatus(msg, color) {
            const indicator = document.getElementById('sync-indicator');
            const statusText = document.getElementById('cloud-status-text');
            if (indicator) {
                indicator.innerText = msg;
                indicator.className = `mt-4 text-[9px] font-black px-3 py-1 rounded-full inline-block uppercase tracking-widest border border-slate-200 ${color.replace('text', 'text').replace('400', '600')} bg-slate-100`;
            }
            if (statusText) statusText.innerText = msg;
        }

        function saveConfig() {
            const url = document.getElementById('cfg-url').value.trim();
            const key = document.getElementById('cfg-key').value.trim();
            if (!url || !key) return alert("URL y Key son obligatorias.");

            localStorage.setItem('sb_url', url);
            localStorage.setItem('sb_key', key);
            SB_URL = url;
            SB_KEY = key;

            initSupabase();
            fetchLogs();
        }

        function initSupabase() {
            if (!SB_URL || !SB_KEY) {
                sysLog("Faltan credenciales.", "text-amber-500");
                updateStatus("Sin Configuración", "text-amber-500");
                return;
            }

            try {
                if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                    supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
                    sysLog(`Supabase init: ${SB_URL}`, "text-sky-400");
                } else {
                    sysLog("Error: SDK not loaded.", "text-rose-500");
                }
            } catch (e) {
                sysLog("Init Error: " + e.message, "text-rose-500");
            }
        }

        // --- DYNAMIC DATA STORAGE ---
        const uuid = () => 'id_' + Math.random().toString(36).substr(2, 9);

        // RESTORED FULL SEED DATA
        const SEED_DATA = {
            repeaters: [
                { id: uuid(), loc: 'R0 GANEKOGORTA', rx: '145.600', tx: '145.000', off: '-0.600', t: '123.0' },
                { id: uuid(), loc: 'R1 SOLLUBE', rx: '145.625', tx: '145.025', off: '-0.600', t: 'NONE' },
                { id: uuid(), loc: 'R2 LA GARBEA', rx: '145.650', tx: '145.050', off: '-0.600', t: '123.0' },
                { id: uuid(), loc: 'R3 PAGASARRI', rx: '145.675', tx: '145.075', off: '-0.600', t: '82.5' },
                { id: uuid(), loc: 'R4 VALLE DE MENA', rx: '145.700', tx: '145.100', off: '-0.600', t: '123.0' },
                { id: uuid(), loc: 'R5 EIBAR', rx: '145.725', tx: '145.125', off: '-0.600', t: '77.0' },
                { id: uuid(), loc: 'R6 MONTE OIZ', rx: '145.750', tx: '145.150', off: '-0.600', t: '82.5' },
                { id: uuid(), loc: 'R7 KARRANTZA', rx: '145.775', tx: '145.175', off: '-0.600', t: '123.0' },
                { id: uuid(), loc: 'U78 PAGASARRI', rx: '438.850', tx: '431.250', off: '-7.600', t: '123.0' },
                { id: uuid(), loc: 'U82 GANEKOGORTA', rx: '438.950', tx: '431.350', off: '-7.600', t: '123.0' },
                { id: uuid(), loc: 'U84 OIZ UHF', rx: '439.000', tx: '431.400', off: '-7.600', t: '82.5' },
                { id: uuid(), loc: 'U86 SOLLUBE UHF', rx: '439.050', tx: '431.450', off: '-7.600', t: '123.0' },
                { id: uuid(), loc: 'ED2ZAA DMR BILBAO', rx: '438.225', tx: '430.625', off: '-7.600', t: 'CC 1' },
                { id: uuid(), loc: 'ED2ZAB DMR SOLLUBE', rx: '438.525', tx: '430.925', off: '-7.600', t: 'CC 1' }
            ],
            pmr: Array.from({ length: 16 }, (_, i) => {
                const freqs = ['446.00625', '446.01875', '446.03125', '446.04375', '446.05625', '446.06875', '446.08125', '446.09375', '446.10625', '446.11875', '446.13125', '446.14375', '446.15625', '446.16875', '446.18125', '446.19375'];
                return { id: uuid(), c: (i + 1).toString(), f: freqs[i], m: 'NFM', p: i === 7 ? 'MID' : 'LOW', u: i === 7 ? 'EMERGENCIA' : 'Uso Libre' };
            }),
            emerg: [
                {id: uuid(), s: 'Salvamento Marítimo', f: '156.800', m: 'FM', n: 'Canal 16 Náutico Internacional', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'REM (Montaña)', f: '146.175', m: 'FM', n: 'Red Emergencia Montaña - Auxilio', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Prot. Civil Basauri', f: '152.325', m: 'FM', n: 'Coordinación Local Protección Civil', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Cruz Roja Euskadi', f: '164.308', m: 'FM', n: 'Operativos Cruz Roja', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Emergencias Bizkaia', f: '146.508', m: 'FM', n: 'QAP Local - Coordinación Emergencias', tx: 'RX ONLY', type: 'EMERG' },

            {id: uuid(), s: 'Bomberos Bizkaia', f: '169.5125', m: 'FM', n: 'Consorcio Bomberos - Operativa Principal', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Bomberos Bizkaia', f: '169.7625', m: 'FM', n: 'Consorcio Bomberos - Coordinación', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'DYA Euskadi', f: '144.800', m: 'FM', n: 'Asistencia Sanitaria Voluntaria', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'DYA Euskadi', f: '146.200', m: 'FM', n: 'Emergencias DYA', tx: 'RX ONLY', type: 'EMERG' },

            {id: uuid(), s: 'Osakidetza Ambulancias', f: '164.0625', m: 'FM', n: 'Coordinación ambulancias', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Osakidetza Soporte Avanzado', f: '164.2875', m: 'FM', n: 'Emergencias sanitarias', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'SAMUR País Vasco', f: '155.275', m: 'FM', n: 'Emergencia sanitaria móvil', tx: 'RX ONLY', type: 'EMERG' },

            {id: uuid(), s: 'Puerto de Bilbao', f: '156.600', m: 'FM', n: 'Canal 12 - Operaciones portuarias', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Puerto de Bilbao', f: '156.700', m: 'FM', n: 'Canal 14 - Control tráfico portuario', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Puerto de Bilbao', f: '156.450', m: 'FM', n: 'Canal 9 - Comunicaciones internas', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Capitán Marítima Bilbao', f: '157.850', m: 'FM', n: 'Canal 27 - Coordinación marítima', tx: 'RX ONLY', type: 'EMERG' },

            {id: uuid(), s: 'Metro de Bilbao', f: '160.050', m: 'FM', n: 'Comunicaciones trenes/control', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Metro de Bilbao', f: '161.300', m: 'FM', n: 'Seguridad y mantenimiento', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'EuskoTren', f: '161.625', m: 'FM', n: 'Operaciones ferroviarias', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Bilbobus', f: '169.2125', m: 'FM', n: 'Coordinación flota transporte urbano', tx: 'RX ONLY', type: 'EMERG' },

            {id: uuid(), s: 'Protección Civil Bilbao', f: '152.225', m: 'FM', n: 'Coordinación municipal Bilbao', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Protección Civil Barakaldo', f: '152.425', m: 'FM', n: 'Coordinación municipal Barakaldo', tx: 'RX ONLY', type: 'EMERG' },
            {id: uuid(), s: 'Protección Civil Portugalete', f: '152.525', m: 'FM', n: 'Coordinación municipal Portugalete', tx: 'RX ONLY', type: 'EMERG' },
            
            { id: uuid(), s: 'LEBB Loiu APP', f: '120.700', m: 'AM', n: 'Aproximación', tx: 'RX ONLY', type: 'AIR' },
            { id: uuid(), s: 'LEBB Loiu Torre', f: '118.500', m: 'AM', n: 'Torre Control', tx: 'RX ONLY', type: 'AIR' },
            { id: uuid(), s: 'LEBB Loiu Tierra', f: '121.700', m: 'AM', n: 'Rodadura', tx: 'RX ONLY', type: 'AIR' }

            ],
            fm: [
                { id: uuid(), e: 'Radio Nervión', f: '88.0', z: 'Bilbao', s: 'MAX' },
                { id: uuid(), e: 'Los 40 Classic', f: '88.5', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Los 40 Bilbao', f: '89.5', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Radio 3 RNE', f: '90.3', z: 'Bizkaia', s: 'ALTA' },
                { id: uuid(), e: 'Radio Euskadi', f: '91.7', z: 'Bizkaia', s: 'MAX' },
                { id: uuid(), e: 'Radio 7', f: '92.7', z: 'Barakaldo', s: 'ALTA' },
                { id: uuid(), e: 'Rock FM', f: '93.6', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Kiss FM', f: '95.2', z: 'Bilbao', s: 'MEDIA' },
                { id: uuid(), e: 'Cadena SER', f: '96.5', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Euskadi Gaztea', f: '97.2', z: 'Bizkaia', s: 'ALTA' },
                { id: uuid(), e: 'RNE 1', f: '99.2', z: 'Bizkaia', s: 'ALTA' },
                { id: uuid(), e: 'Cadena 100', f: '100.0', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Onda Cero', f: '101.5', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Bizkaia Irratia', f: '102.6', z: 'Durangaldea', s: 'MEDIA' },
                { id: uuid(), e: 'COPE Bilbao', f: '103.8', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Melodia FM', f: '104.5', z: 'Bilbao', s: 'MEDIA' },
                { id: uuid(), e: 'Radio Maria', f: '105.8', z: 'Bilbao', s: 'BAJA' },
                { id: uuid(), e: 'Hit FM', f: '106.3', z: 'Bilbao', s: 'MEDIA' },
                { id: uuid(), e: 'Euskadi Irratia', f: '107.4', z: 'Bizkaia', s: 'ALTA' },
                { id: uuid(), e: 'Radio Gorbea', f: '93.1', z: 'Vitoria/Sur', s: 'BAJA' },
                { id: uuid(), e: 'Onda Vasca', f: '90.1', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Europa FM', f: '98.4', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Radio Tropical', f: '102.9', z: 'Bilbao', s: 'MEDIA' },
                { id: uuid(), e: 'Arratia Irratia', f: '104.9', z: 'Igorre', s: 'BAJA' },
                { id: uuid(), e: 'Radio Vitoria', f: '104.1', z: 'Álava/Sur', s: 'BAJA' },
                { id: uuid(), e: 'Radio Popular', f: '92.2', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Kosta Irratia', f: '104.7', z: 'Bakio', s: 'BAJA' },
                { id: uuid(), e: 'Tas-Tas Irratia', f: '97.0', z: 'Bilbao', s: 'BAJA' },
                { id: uuid(), e: 'Irola Irratia', f: '107.5', z: 'Irala', s: 'BAJA' },
                { id: uuid(), e: '97 Irratia', f: '97.0', z: 'Bilbao', s: 'BAJA' },
                { id: uuid(), e: 'Radio Encartaciones', f: '101.9', z: 'Zalla', s: 'BAJA' },
                { id: uuid(), e: 'Bilbo Hiria', f: '96.0', z: 'Bilbao', s: 'BAJA' },
                { id: uuid(), e: 'Loca FM', f: '105.4', z: 'Bilbao', s: 'MEDIA' },
                { id: uuid(), e: 'Antena 3 RNE', f: '103.2', z: 'Bizkaia', s: 'ALTA' },
                { id: uuid(), e: 'Radio Marca', f: '103.4', z: 'Bilbao', s: 'MEDIA' },
                { id: uuid(), e: 'Radio 5 RNE', f: '100.7', z: 'Bizkaia', s: 'ALTA' },
                { id: uuid(), e: 'Hala Bedi', f: '107.4', z: 'Vitoria', s: 'BAJA' },
                { id: uuid(), e: 'Cadena Dial', f: '88.8', z: 'Bilbao', s: 'ALTA' },
                { id: uuid(), e: 'Radio Oro', f: '95.2', z: 'Bilbao', s: 'MEDIA' },
                { id: uuid(), e: 'Radio Candela', f: '98.0', z: 'Bilbao', s: 'BAJA' },
                { id: uuid(), e: 'Very Bilbao', f: '100.9', z: 'Bilbao', s: 'MEDIA' },
                { id: uuid(), e: 'Tropical FM', f: '102.2', z: 'Bilbao', s: 'BAJA' }
            ],

            hardware: [
                { id: uuid(), r: '65.0 - 108.0', s: 'FM Comercial', u: 'Radiodifusión FM (WFM)', m: 'WFM', tx: 'RX' },
                { id: uuid(), r: '108.0 - 117.9', s: 'Banda Aérea', u: 'VOR / Navegación (Solo Balizas)', m: 'AM', tx: 'RX' },
                { id: uuid(), r: '118.0 - 136.9', s: 'Banda Aérea', u: 'Comunicaciones Voz Aérea (AM)', m: 'AM', tx: 'RX' },
                { id: uuid(), r: '144.0 - 144.150', s: '2M Amateur', u: 'CW (Telegrafía) - Uso Exclusivo', m: 'CW', tx: 'TX OK' },
                { id: uuid(), r: '144.150 - 144.4', s: '2M Amateur', u: 'SSB (Banda Lateral) / DX', m: 'USB', tx: 'TX OK' },
                { id: uuid(), r: '144.5 - 144.9', s: '2M Amateur', u: 'Todos los Modos / Digital / SSTV', m: 'FM', tx: 'TX OK' },
                { id: uuid(), r: '145.0 - 145.175', s: '2M Amateur', u: 'Entrada Repetidores (R0-R7)', m: 'FM', tx: 'TX OK' },
                { id: uuid(), r: '145.2 - 145.575', s: '2M Amateur', u: 'FM Simplex (145.500 Llamada)', m: 'FM', tx: 'TX OK' },
                { id: uuid(), r: '145.6 - 145.775', s: '2M Amateur', u: 'Salida Repetidores (R0-R7)', m: 'FM', tx: 'TX OK' },
                { id: uuid(), r: '145.8 - 146.0', s: '2M Amateur', u: 'Satélites (ISS Downlink)', m: 'FM', tx: 'TX OK' },
                { id: uuid(), r: '146.0 - 174.0', s: 'VHF Pro', u: 'Servicios Profesionales / Caza / Emerg', m: 'FM', tx: 'TX OK' },
                { id: uuid(), r: '430.0 - 432.0', s: '70cm Amateur', u: 'CW / SSB / Digital', m: 'USB', tx: 'TX OK' },
                { id: uuid(), r: '433.0 - 433.575', s: '70cm Amateur', u: 'FM Simplex (433.500 Llamada)', m: 'FM', tx: 'TX OK' },
                { id: uuid(), r: '438.650 - 439.425', s: '70cm Amateur', u: 'Salida Repetidores UHF', m: 'FM', tx: 'TX OK' },
                { id: uuid(), r: '446.0 - 446.2', s: 'PMR446', u: 'Uso Libre sin licencia', m: 'NFM', tx: 'TX OK' }
            ]
        };

        // GLOBAL DATA STATE
        let db = {
            repeaters: [],
            pmr: [],
            emerg: [],
            fm: [],
            hardware: []
        };

        // --- SQL INSTALL GENERATOR ---
        function showInstallSQL() {
            const sql = `
-- TABLA REPETIDORES
create table if not exists db_repeaters (
  id text primary key,
  loc text, rx text, tx text, off text, t text
);

-- TABLA PMR
create table if not exists db_pmr (
  id text primary key,
  c text, f text, m text, p text, u text
);

-- TABLA EMERG/AIRE
create table if not exists db_emerg (
  id text primary key,
  s text, f text, m text, n text, tx text, type text
);

-- TABLA FM
create table if not exists db_fm (
  id text primary key,
  e text, f text, z text, s text
);

-- TABLA HARDWARE
create table if not exists db_hardware (
  id text primary key,
  r text, s text, u text, m text, tx text
);
            `.trim();
            const area = document.getElementById('sql-area');
            area.value = sql;
            document.getElementById('sql-box').classList.remove('hidden');
        }

        // --- CRUD LOGIC ---
        function loadLocalData() {
            db.repeaters = JSON.parse(localStorage.getItem('db_repeaters')) || [];
            db.pmr = JSON.parse(localStorage.getItem('db_pmr')) || [];
            db.emerg = JSON.parse(localStorage.getItem('db_emerg')) || [];
            db.fm = JSON.parse(localStorage.getItem('db_fm')) || [];
            db.hardware = JSON.parse(localStorage.getItem('db_hardware')) || [];
            
            // SANITY CHECK: Ensure all items have ID
            ['repeaters', 'pmr', 'emerg', 'fm', 'hardware'].forEach(k => {
                if(db[k]) {
                    db[k].forEach(item => {
                        if(!item.id) item.id = uuid();
                    });
                }
            });
            
            // Fallback seed if local is totally empty
            if(db.repeaters.length === 0) db.repeaters = SEED_DATA.repeaters;
            if(db.pmr.length === 0) db.pmr = SEED_DATA.pmr;
            if(db.emerg.length === 0) db.emerg = SEED_DATA.emerg;
            if(db.fm.length === 0) db.fm = SEED_DATA.fm;
            if(db.hardware.length === 0) db.hardware = SEED_DATA.hardware;
        }

        function saveAllLocal() {
            localStorage.setItem('db_repeaters', JSON.stringify(db.repeaters));
            localStorage.setItem('db_pmr', JSON.stringify(db.pmr));
            localStorage.setItem('db_emerg', JSON.stringify(db.emerg));
            localStorage.setItem('db_fm', JSON.stringify(db.fm));
            localStorage.setItem('db_hardware', JSON.stringify(db.hardware));
        }

        async function syncAndSeed(tableName, stateKey, seedKey) {
            if (!supabaseClient) return false;
            try {
                let { data, error } = await supabaseClient.from(tableName).select('*');
                
                if (error) throw error;

                if (!data || data.length === 0) {
                    // Empty table? Seed it initially.
                    sysLog(`Table ${tableName} is empty. Seeding...`, 'text-blue-400');
                    const seed = SEED_DATA[seedKey];
                    const { error: insertError } = await supabaseClient.from(tableName).insert(seed);
                    
                    if (!insertError) {
                         sysLog(`Seeding OK: ${tableName}`, 'text-emerald-400');
                         db[stateKey] = seed;
                         return true;
                    } else {
                        sysLog(`Seeding Failed ${tableName}: ` + insertError.message, 'text-rose-400');
                        // Use local memory fallback
                        db[stateKey] = SEED_DATA[seedKey];
                        return false;
                    }
                } else {
                    db[stateKey] = data;
                    return true;
                }
            } catch (e) {
                console.log(`Table ${tableName} sync error:`, e.message);
                return false;
            }
        }

        // --- NEW: SMART MERGE LOGIC ---
        async function uploadMissingSeedData() {
            if (!supabaseClient) return alert("Conecta con Supabase primero.");
            if (!confirm("Esto subirá los datos semilla (FM, Repeater, etc.) que NO existan en la nube. Tus datos actuales NO se borrarán. ¿Continuar?")) return;
            if (!checkAuthSync('fusionar datos')) return;

            sysLog("Iniciando fusión inteligente...", "text-indigo-400");
            
            const configs = [
                { table: 'db_repeaters', key: 'repeaters', match: ['loc', 'rx'] },
                { table: 'db_pmr', key: 'pmr', match: ['c', 'f'] },
                { table: 'db_emerg', key: 'emerg', match: ['s', 'f'] },
                { table: 'db_fm', key: 'fm', match: ['e', 'f'] },
                { table: 'db_hardware', key: 'hardware', match: ['r', 's'] }
            ];

            for (const cfg of configs) {
                const seedItems = SEED_DATA[cfg.key];
                if (!seedItems) continue;

                // Fetch current cloud data
                const { data: currentCloud, error } = await supabaseClient.from(cfg.table).select('*');
                if (error) {
                    sysLog(`Error leyendo ${cfg.table}: ${error.message}`, 'text-rose-400');
                    continue;
                }

                let added = 0;
                let updated = 0;

                for (const seedItem of seedItems) {
                    // Try to find a match by content (not ID)
                    const match = currentCloud.find(cloudItem => 
                        cloudItem[cfg.match[0]] === seedItem[cfg.match[0]] && 
                        cloudItem[cfg.match[1]] === seedItem[cfg.match[1]]
                    );

                    if (match) {
                        // Exists. Optionally update? Let's assume seed is truth for static data.
                        // We will update everything EXCEPT the ID to preserve references if any.
                        const { id, ...dataToUpdate } = seedItem;
                        await supabaseClient.from(cfg.table).update(dataToUpdate).eq('id', match.id);
                        updated++;
                    } else {
                        // Does not exist. Insert new.
                        await supabaseClient.from(cfg.table).insert(seedItem);
                        added++;
                    }
                }
                sysLog(`${cfg.table}: +${added} nuevos, ~${updated} actualizados.`, "text-indigo-300");
            }

            sysLog("Fusión completada. Recargando...", "text-emerald-400");
            setTimeout(fetchLogs, 1000);
        }

        async function fetchLogs() {
            if (!supabaseClient) initSupabase();
            
            // Load local first for speed
            loadLocalData();
            
            if (supabaseClient) {
                sysLog("Syncing DB Tables...");
                // Normal sync
                await Promise.all([
                    syncAndSeed('db_repeaters', 'repeaters', 'repeaters'),
                    syncAndSeed('db_pmr', 'pmr', 'pmr'),
                    syncAndSeed('db_emerg', 'emerg', 'emerg'),
                    syncAndSeed('db_fm', 'fm', 'fm'),
                    syncAndSeed('db_hardware', 'hardware', 'hardware')
                ]);
                saveAllLocal();
            }

            // Fetch Logbook
            try {
                const { data, error } = await supabaseClient
                    .from('logs')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const localOnly = logs.filter(l => l.id && l.id.toString().startsWith('local_'));
                logs = [...localOnly, ...(data || [])];
                localStorage.setItem('basauri_logs_backup', JSON.stringify(logs));
                updateStatus("Sync: Cloud Online", "text-emerald-400");
            } catch (err) {
               logs = JSON.parse(localStorage.getItem('basauri_logs_backup')) || [];
               if(supabaseClient) updateStatus("Offline Mode", "text-amber-400");
            }
            
            renderAll();
        }

        // --- CORE CRUD OPERATIONS ---

        async function saveResource(e) {
            e.preventDefault();
            const form = document.getElementById('resource-form');
            const id = document.getElementById('res-id').value; // Read hidden ID
            const type = document.getElementById('res-type').value;

            // Security Check for Updates
            if (id) {
                 if (!checkAuthSync('editar')) return;
            }

            const formData = new FormData(form);
            const obj = {};
            formData.forEach((value, key) => obj[key] = value);
            
            // Logic to preserve or create ID
            let updateMode = false;
            
            if (id) {
                updateMode = true;
                // Update Local Memory
                const idx = db[type].findIndex(x => x.id === id);
                if (idx !== -1) {
                    // Merge new values into existing object to preserve ID and any hidden fields not in form
                    db[type][idx] = { ...db[type][idx], ...obj };
                }
            } else {
                // Create New
                obj.id = uuid();
                if(type === 'emerg' && !obj.type) obj.type = 'EMERG'; 
                db[type].push(obj);
            }

            saveAllLocal();
            closeResourceModal();
            renderAll(); // Immediate UI Update
            
            // Cloud Sync
            if (supabaseClient) {
                const tableName = 'db_' + type;
                let error = null;
                
                if (updateMode) {
                    // Important: Send all object keys to ensure full update
                     const result = await supabaseClient.from(tableName).update(obj).eq('id', id);
                     error = result.error;
                } else {
                     const result = await supabaseClient.from(tableName).insert([obj]);
                     error = result.error;
                }
                
                if (error) {
                    console.error(error);
                    sysLog(`Cloud Sync Error: ${error.message}`, "text-rose-500");
                    alert("Guardado local OK, pero falló la nube.");
                } else {
                    sysLog(`Resource ${type} ${updateMode ? 'updated' : 'created'}.`, "text-blue-400");
                }
            }
        }

        // EXPOSED GLOBALLY FOR ONCLICK EVENTS
        window.deleteResource = async function(type, id) {
            console.log("Intento borrar:", type, id);
            
            // Native confirm doesn't block UI efficiently in all contexts but is simplest here.
            if (!confirm("¿Borrar recurso permanentemente?")) return;
            
            if (!checkAuthSync('borrar')) return;

            db[type] = db[type].filter(x => x.id !== id);
            saveAllLocal();
            renderAll(); // Immediate UI Update

            if (supabaseClient) {
                const { error } = await supabaseClient.from('db_' + type).delete().eq('id', id);
                if(error) {
                     sysLog(`Delete Error: ${error.message}`, "text-rose-500");
                } else {
                     sysLog(`Resource deleted from cloud.`, "text-rose-400");
                }
            }
        }

        // --- MODAL LOGIC ---
        const CONFIG_FIELDS = {
            repeaters: [
                {k: 'loc', l: 'Ubicación / ID'}, 
                {k: 'rx', l: 'RX (MHz)', type: 'freq'}, 
                {k: 'tx', l: 'TX (MHz)', type: 'freq'}, 
                {k: 'off', l: 'Offset'}, 
                {k: 't', l: 'Subtono'}
            ],
            pmr: [
                {k: 'c', l: 'Canal'}, 
                {k: 'f', l: 'Frecuencia', type: 'freq'}, 
                {k: 'm', l: 'Modo (NFM)', type: 'select', options: ['NFM', 'FM']}, 
                {k: 'p', l: 'Potencia'}, 
                {k: 'u', l: 'Uso'}
            ],
            emerg: [
                {k: 's', l: 'Servicio'}, 
                {k: 'f', l: 'Frecuencia', type: 'freq'},
                {k: 'm', l: 'Modulación', type: 'select', options: ['FM', 'AM', 'USB', 'CW']}, 
                {k: 'n', l: 'Notas'},
                {k: 'tx', l: 'Estado TX', type: 'select', options: ['RX ONLY', 'TX OK']}, 
                {k: 'type', l: 'Tipo (EMERG/AIR)', hidden: true}
            ],
            fm: [
                {k: 'e', l: 'Emisora'}, 
                {k: 'f', l: 'Frecuencia', type: 'freq'},
                {k: 'z', l: 'Zona'}, 
                {k: 's', l: 'Señal', type: 'select', options: ['MAX', 'ALTA', 'MEDIA', 'BAJA']}
            ],
            hardware: [
                {k: 'r', l: 'Rango MHz'}, 
                {k: 's', l: 'Sub-Banda'},
                {k: 'u', l: 'Uso'}, 
                {k: 'm', l: 'Modo', type: 'select', options: ['FM', 'WFM', 'AM', 'USB', 'CW']}, 
                {k: 'tx', l: 'TX Status', type: 'select', options: ['TX OK', 'RX', 'UNLOCKED']}
            ]
        };
        
        // Helper to mask frequency input
        function formatFreqInput(input) {
            // Remove non-numeric/non-dot
            let val = input.value.replace(/[^0-9.]/g, '');
            // Prevent multiple dots
            const parts = val.split('.');
            if(parts.length > 2) {
                val = parts[0] + '.' + parts.slice(1).join('');
            }
            input.value = val;
        }

        function openResourceModal(type, subType = null) {
            document.getElementById('resource-modal').classList.remove('hidden');
            document.getElementById('res-type').value = type;
            document.getElementById('res-id').value = '';
            document.getElementById('modal-title').innerText = `AÑADIR A ${type.toUpperCase()}`;
            
            const fields = CONFIG_FIELDS[type];
            const container = document.getElementById('modal-fields');
            container.innerHTML = fields.map(f => {
                const val = subType && f.k === 'type' ? subType : '';
                
                // Hidden field handling
                if (f.hidden) {
                     return `<input type="hidden" name="${f.k}" value="${val}">`;
                }

                let inputHtml = '';
                // Select type
                if (f.type === 'select') {
                    const opts = f.options.map(o => `<option value="${o}">${o}</option>`).join('');
                    inputHtml = `<select name="${f.k}" class="w-full p-3 border border-slate-300 rounded-lg text-sm font-bold bg-slate-50 focus:bg-white">${opts}</select>`;
                } 
                // Frequency type
                else if (f.type === 'freq') {
                    inputHtml = `<input type="text" name="${f.k}" value="${val}" placeholder="145.500" inputmode="decimal" oninput="formatFreqInput(this)" class="w-full p-3 border border-slate-300 rounded-lg text-sm font-bold mono bg-slate-50 focus:bg-white">`;
                } 
                // Default text type
                else {
                    inputHtml = `<input type="text" name="${f.k}" value="${val}" class="w-full p-3 border border-slate-300 rounded-lg text-sm font-bold bg-slate-50 focus:bg-white">`;
                }

                return `
                <div>
                    <label class="block text-[10px] font-extrabold uppercase text-slate-500 mb-1 tracking-wide">${f.l}</label>
                    ${inputHtml}
                </div>
            `}).join('');
        }

        function editResource(type, id) {
            const item = db[type].find(x => x.id === id);
            if (!item) return;

            openResourceModal(type);
            document.getElementById('res-id').value = id;
            document.getElementById('modal-title').innerText = `EDITAR ${type.toUpperCase()}`;
            
            // Fill inputs (text, freq, hidden) AND selects
            const inputs = document.querySelectorAll('#resource-form input, #resource-form select');
            inputs.forEach(inp => {
                if (item[inp.name]) inp.value = item[inp.name];
            });
        }

        function closeResourceModal() {
            document.getElementById('resource-modal').classList.add('hidden');
            document.getElementById('resource-form').reset();
        }
        
        document.getElementById('resource-form').onsubmit = saveResource;

        // --- QSO HANDLERS ---
        document.getElementById('qso-form').onsubmit = async function (e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerText = editingId ? "Actualizando..." : "Guardando...";

            const formValues = {
                callsign: document.getElementById('callsign').value.toUpperCase(),
                rst: document.getElementById('rst').value,
                band: document.getElementById('band').value,
                comment: document.getElementById('comment').value
            };

            if (editingId) {
                // UPDATE LOGIC
                const index = logs.findIndex(l => l.id == editingId);
                if (index !== -1) {
                    logs[index] = { ...logs[index], ...formValues }; // Merge changes
                    localStorage.setItem('basauri_logs_backup', JSON.stringify(logs));
                    renderAll();
                    sysLog(`Updated Local ID: ${editingId}`, "text-blue-400");

                    if (supabaseClient && !logs[index].id.toString().startsWith('local_')) {
                        await updateCloud(logs[index]);
                    }
                }
                cancelEdit(); // Reset UI
            } else {
                // CREATE LOGIC
                const qso = {
                    ...formValues,
                    created_at: new Date().toISOString()
                };

                const tempId = 'local_' + Date.now();
                const localQso = { ...qso, id: tempId };
                logs.unshift(localQso);
                localStorage.setItem('basauri_logs_backup', JSON.stringify(logs));
                renderAll();

                this.reset(); // Only reset on create

                if (supabaseClient) {
                    const result = await saveToCloud(qso);
                    if (result) {
                        const idx = logs.findIndex(l => l.id === tempId);
                        if (idx !== -1) {
                            logs[idx] = result;
                            localStorage.setItem('basauri_logs_backup', JSON.stringify(logs));
                            renderAll();
                            sysLog(`QSO saved & synced. ID: ${result.id}`, "text-emerald-500");
                        }
                    } else {
                        sysLog("Guardado local. Falló Nube.", "text-amber-500");
                    }
                } else {
                    sysLog("Guardado local (Modo Offline).", "text-amber-500");
                }
            }

            btn.disabled = false;
            if (!editingId) btn.innerText = "Nuevo QRZ";
        };

        function handleEdit(id) {
            const l = logs.find(x => x.id == id);
            if (!l) return;

            editingId = id;
            document.getElementById('callsign').value = l.callsign;
            document.getElementById('rst').value = l.rst;
            document.getElementById('band').value = l.band;
            document.getElementById('comment').value = l.comment || '';

            const btn = document.getElementById('submit-btn');
            btn.innerText = "ACTUALIZAR DATOS";
            btn.classList.remove('btn-primary');
            btn.classList.add('bg-sky-600', 'text-white', 'hover:bg-sky-500', 'border-sky-400'); // Updated style for dark mode

            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            // Form card style is now fixed to dark, so we don't swap border colors anymore, just scroll
            
            // Scroll to form
            document.getElementById('tab-logbook').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingId = null;
            document.getElementById('qso-form').reset();

            const btn = document.getElementById('submit-btn');
            btn.innerText = "Registrar QSO";
            btn.classList.add('btn-primary');
            btn.classList.remove('bg-sky-600', 'text-white', 'hover:bg-sky-500', 'border-sky-400');

            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        async function handleDelete(id) {
            if (!confirm("¿ELIMINAR CONTACTO?")) return;
            if (!checkAuthSync('borrar')) return;

            if (editingId == id) cancelEdit();

            const backup = [...logs];
            logs = logs.filter(l => l.id != id); 
            localStorage.setItem('basauri_logs_backup', JSON.stringify(logs));
            renderAll();

            if (!id.toString().startsWith('local_') && supabaseClient) {
                const success = await deleteFromCloud(id);
                if (!success) {
                    alert("Error al borrar en nube. Se revertirá la acción.");
                    logs = backup;
                    localStorage.setItem('basauri_logs_backup', JSON.stringify(logs));
                    renderAll();
                }
            }
        }
        
        // --- SYNC HELPERS FOR LOGS ---
        async function saveToCloud(qso) {
            if (!supabaseClient) return false;
            try {
                const { id, ...qsoData } = qso;
                const { data, error } = await supabaseClient.from('logs').insert([qsoData]).select();
                if (error) throw error;
                return data ? data[0] : true;
            } catch (err) {
                sysLog("Save Error: " + err.message, "text-rose-400");
                return false;
            }
        }

        async function updateCloud(qso) {
            if (!supabaseClient) return;
            try {
                const { id, ...data } = qso;
                const { error } = await supabaseClient.from('logs').update(data).eq('id', id);
                if (error) throw error;
                sysLog(`Cloud Update OK: ${id}`, "text-blue-400");
            } catch (e) {
                sysLog("Update Failed: " + e.message, "text-rose-400");
            }
        }

        async function deleteFromCloud(id) {
            if (!supabaseClient) return false;
            try {
                const { error } = await supabaseClient.from('logs').delete().eq('id', id);
                return !error;
            } catch (err) { return false; }
        }

        // --- RENDER ---
        function renderActions(type, id) {
            // Using template literal properly. ID is safe alphanumeric.
            return `
            <div class="flex justify-end gap-1">
                <button onclick="editResource('${type}', '${id}')" class="btn-action text-sky-600 hover:bg-sky-50"><i class="fas fa-edit"></i></button>
                <button onclick="deleteResource('${type}', '${id}')" class="btn-action text-rose-500 hover:bg-rose-50"><i class="fas fa-trash"></i></button>
            </div>`;
        }

        function renderAll() {
            // Logic de Búsqueda
            const searchVal = document.getElementById('search-input')?.value.toUpperCase() || '';
            const filteredLogs = logs.filter(l =>
                l.callsign.includes(searchVal) ||
                (l.date && l.date.toUpperCase().includes(searchVal))
            );

            const logCountEl = document.getElementById('log-count');
            if (logCountEl) {
                if (searchVal) {
                    logCountEl.innerText = `${filteredLogs.length} / ${logs.length} RECOLECCION`;
                } else {
                    logCountEl.innerText = `${logs.length} QSO REGISTRADOS`;
                }
            }

            const container = document.getElementById('logs-container');
            if (container) {
                container.innerHTML = filteredLogs.length > 0 ? filteredLogs.map((l) => {
                    // Safe date rendering fallback
                    const displayDate = l.date || (l.created_at ? new Date(l.created_at).toLocaleString() : '');
                    return `
                    <div class="card-tactical p-5 flex justify-between items-center border-l-4 border-l-sky-500 hover:shadow-xl transition-all group bg-white">
                        <div class="overflow-hidden">
                            <div class="flex items-center gap-3 flex-wrap mb-1">
                                <span class="text-2xl font-black italic mono tracking-tighter text-slate-800 uppercase group-hover:text-sky-600 transition-colors">${l.callsign}</span>
                                <span class="bg-sky-50 text-sky-600 text-[10px] font-black px-2 py-0.5 rounded uppercase border border-sky-100">${l.band}</span>
                                ${l.id && l.id.toString().startsWith('local_') ? '<span class="bg-amber-50 text-amber-600 text-[9px] font-black px-2 py-0.5 rounded uppercase border border-amber-100">UNSYNCED</span>' : ''}
                            </div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
                                <i class="far fa-clock"></i> ${displayDate}
                            </div>
                            <div class="text-xs text-slate-500 mt-2 font-medium truncate max-w-md">${l.comment || '<span class="italic text-slate-300">Sin notas</span>'}</div>
                        </div>
                        <div class="flex items-center gap-4 pl-4 border-l border-slate-100">
                            <div class="text-center min-w-[60px]">
                                <div class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">RST</div>
                                <div class="text-2xl font-black text-slate-700 mono">${l.rst}</div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="handleEdit('${l.id}')" class="text-sky-500 hover:bg-sky-50 p-2 rounded-lg transition-colors"><i class="fas fa-edit"></i></button>
                                <button onclick="handleDelete('${l.id}')" class="text-slate-300 hover:text-rose-500 hover:bg-rose-50 p-2 rounded-lg transition-colors"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `}).join('') : '<div class="p-12 text-center text-slate-300 font-bold uppercase italic text-sm border-2 border-dashed border-slate-200 rounded-xl">Sin resultados encontrados</div>';
            }

            // DYNAMIC TABLES RENDER
            const tables = {
                'table-repeaters': db.repeaters.map(r => `<tr><td class="font-bold text-slate-700">${r.loc}</td><td class="mono font-bold text-sky-600">${r.rx}</td><td class="mono text-slate-400">${r.tx}</td><td class="font-bold text-orange-500">${r.off}</td><td class="mono text-[11px] font-black text-slate-600 bg-slate-100 px-2 py-0.5 rounded inline-block">${r.t}</td><td><span class="badge-status status-tx">TX OK</span></td><td>${renderActions('repeaters', r.id)}</td></tr>`).join(''),
                'table-pmr': db.pmr.map(p => `<tr><td class="font-black text-slate-700">CH ${p.c}</td><td class="mono font-bold text-emerald-600">${p.f}</td><td class="text-[10px] font-bold text-slate-400 uppercase">${p.m}</td><td class="font-black text-emerald-600 text-[10px]">${p.p}</td><td class="italic text-[11px] text-slate-500">${p.u}</td><td>${renderActions('pmr', p.id)}</td></tr>`).join(''),
                'table-emerg': db.emerg.filter(x => x.type === 'EMERG').map(e => `<tr><td class="font-bold text-slate-700 text-[11px]">${e.s}</td><td class="mono font-bold text-rose-500">${e.f}</td><td class="text-slate-400 font-bold text-[10px] uppercase">${e.m}</td><td class="text-[11px] text-slate-500 font-medium">${e.n}</td><td><span class="badge-status status-rx">${e.tx}</span></td><td>${renderActions('emerg', e.id)}</td></tr>`).join(''),
                'table-air': db.emerg.filter(x => x.type === 'AIR').map(a => `<tr><td class="font-bold text-[11px] text-slate-700">${a.s}</td><td class="mono font-bold text-slate-600">${a.f}</td><td class="text-[10px] font-black text-sky-600 uppercase">${a.m}</td><td class="italic text-[11px] text-slate-400">${a.n}</td><td>${renderActions('emerg', a.id)}</td></tr>`).join(''),
                'table-fm': db.fm.map(f => `<tr><td class="font-bold text-slate-700">${f.e}</td><td class="mono font-bold text-indigo-600">${f.f}</td><td class="text-slate-400 text-[11px] font-medium">${f.z}</td><td class="text-[9px] font-black text-indigo-400 uppercase bg-indigo-50 px-2 py-0.5 rounded">${f.s}</td><td>${renderActions('fm', f.id)}</td></tr>`).join(''),
                'table-h8': db.hardware.map(h => `<tr class="hover:bg-slate-50"><td class="mono font-bold text-slate-800 whitespace-nowrap">${h.r}</td><td class="font-black text-sky-600 uppercase text-[10px] tracking-wide">${h.s}</td><td class="font-bold text-slate-400 text-[10px] italic">${h.u}</td><td class="font-bold text-slate-700 text-[10px] uppercase bg-slate-100 px-2 py-0.5 rounded inline-block">${h.m}</td><td><span class="badge-status ${h.tx === 'TX OK' ? 'status-tx' : (h.tx === 'UNLOCKED' ? 'status-unlocked' : 'status-rx')}">${h.tx}</span></td><td>${renderActions('hardware', h.id)}</td></tr>`).join('')
            };

            Object.entries(tables).forEach(([id, html]) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            });
        }

        document.getElementById('import-json').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;

            sysLog("Reading file...");
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    const list = Array.isArray(imported) ? imported : [imported];

                    sysLog(`Importing ${list.length} records locally...`);

                    let importedCount = 0;
                    for (const item of list.reverse()) {
                        const qso = {
                            callsign: (item.callsign || 'NOCALL').toUpperCase(),
                            rst: item.rst || '59',
                            band: item.band || 'Unknown',
                            comment: item.comment || '',
                            date: item.date || new Date().toLocaleString(),
                            created_at: item.created_at || new Date().toISOString(),
                            id: 'local_imp_' + Date.now() + Math.random().toString(36).substr(2, 9)
                        };
                        logs.unshift(qso);
                        importedCount++;
                    }

                    localStorage.setItem('basauri_logs_backup', JSON.stringify(logs));
                    renderAll();
                    sysLog("Importación local finalizada.", "text-emerald-500");

                    if (supabaseClient) {
                        sysLog("Intentando subir a la nube en background...");
                        let synced = 0;
                        const toSync = logs.filter(l => l.id.toString().startsWith('local_imp_'));

                        for (const l of toSync) {
                            const result = await saveToCloud(l);
                            if (result) {
                                const idx = logs.findIndex(x => x.id === l.id);
                                if (idx !== -1) logs[idx] = result;
                                synced++;
                            }
                        }

                        if (synced > 0) {
                            localStorage.setItem('basauri_logs_backup', JSON.stringify(logs));
                            renderAll();
                            sysLog(`Sync completada: ${synced}/${toSync.length} subidos.`, "text-emerald-500");
                        }
                    } else {
                        alert("Importado SOLO localmente. Configura Supabase para sincronizar.");
                    }

                } catch (err) {
                    console.error(err);
                    alert("Archivo JSON no válido.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        });

        function exportJSON() {
            const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `basauri_logs_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
        }

        // --- CSV EXPORT LOGIC ---
        function downloadCSV() {
            const headers = [
                "Location", "Name", "Frequency", "Duplex", "Offset", "Tone",
                "rToneFreq", "cToneFreq", "DtcsCode", "DtcsPolarity",
                "RxDtcsCode", "CrossMode", "Mode", "TStep", "Skip",
                "Power", "Comment", "URCALL", "RPT1CALL", "RPT2CALL", "DVCODE"
            ].join(",");

            let loc = 1;
            const rows = [];
            const fmt = f => parseFloat(f).toFixed(5);
            const name = s => s.replace(/,/g, '').substring(0, 8).toUpperCase();
            const magicCols = "023,NN,023,Tone->Tone";

            const nextZone = () => {
                if (loc > 1) loc = Math.ceil(loc / 10) * 10;
            };

            db.repeaters.forEach(r => {
                let duplex = '';
                let offset = '0.00000';
                if (r.off && r.off !== '0.000') {
                    const o = parseFloat(r.off);
                    duplex = o < 0 ? '-' : '+';
                    offset = fmt(Math.abs(o));
                }

                let toneStr = '';
                let cTone = '88.5';
                if (r.t && r.t !== 'NONE' && !r.t.startsWith('CC')) {
                    toneStr = 'Tone';
                    cTone = parseFloat(r.t).toFixed(1);
                }

                rows.push([
                    loc++,
                    name(r.loc),
                    fmt(r.rx),
                    duplex, // +/-
                    offset,
                    toneStr,
                    "88.5", 
                    cTone,  
                    magicCols,
                    "FM",
                    "12.5",
                    "",
                    "10.0W", 
                    "", "", "", "", ""
                ].join(','));
            });

            nextZone();

            db.pmr.forEach(p => {
                rows.push([
                    loc++,
                    name(`PMR ${p.c}`),
                    fmt(p.f),
                    "", 
                    "0.00000",
                    "",
                    "88.5", "88.5",
                    magicCols,
                    "NFM",
                    "12.5",
                    "",
                    "0.5W", 
                    "", "", "", "", ""
                ].join(','));
            });

            nextZone();

            db.emerg.filter(x => x.type === 'EMERG').forEach(e => {
                rows.push([
                    loc++,
                    name(e.s),
                    fmt(e.f),
                    "off", 
                    "0.00000",
                    "",
                    "88.5", "88.5",
                    magicCols,
                    "FM",
                    "12.5",
                    "",
                    "10.0W", 
                    e.n || "",
                    "", "", "", ""
                ].join(','));
            });

            nextZone();

            db.emerg.filter(x => x.type === 'AIR').forEach(a => {
                rows.push([
                    loc++,
                    name(a.s.replace('LEBB', 'BIO')),
                    fmt(a.f),
                    "off", 
                    "0.00000",
                    "",
                    "88.5", "88.5",
                    magicCols,
                    "AM",
                    "25.0", 
                    "",
                    "10.0W",
                    a.n || "",
                    "", "", "", ""
                ].join(','));
            });

            const csv = [headers, ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'MASTER_H8.csv';
            a.click();
        }

        function renderSDRWidgets() {
            const svgs = document.querySelectorAll('.sdr-placeholder');
            const svgContent = `
            <svg viewBox="0 0 200 50" class="w-full h-full drop-shadow-lg" preserveAspectRatio="none">
                <!-- Bg -->
                <rect width="200" height="50" fill="#0f172a" rx="4" />
                
                <!-- Grid -->
                <path d="M0 25 L200 25" stroke="#1e293b" stroke-width="1" />
                <path d="M25 0 L25 50 M50 0 L50 50 M75 0 L75 50 M100 0 L100 50 M125 0 L125 50 M150 0 L150 50 M175 0 L175 50" stroke="#1e293b" stroke-width="0.5" stroke-dasharray="2 2" />

                <!-- Waterfall (Bottom) -->
                <defs>
                    <linearGradient id="fallGrad" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stop-color="#0ea5e9" stop-opacity="1" />
                        <stop offset="100%" stop-color="#0f172a" stop-opacity="0" />
                    </linearGradient>
                </defs>
                
                <!-- Signal 1 Waterfall (Left) -->
                <rect x="30" y="25" width="6" height="25" fill="url(#fallGrad)" opacity="0.8">
                    <animate attributeName="y" values="25;50" dur="1.5s" repeatCount="indefinite" />
                    <animate attributeName="height" values="0;25" dur="1.5s" repeatCount="indefinite" />
                    <animate attributeName="opacity" values="0.8;0" dur="1.5s" repeatCount="indefinite" />
                </rect>
                
                <!-- Signal 2 Waterfall (Center-Right) -->
                <rect x="110" y="25" width="4" height="25" fill="url(#fallGrad)" opacity="0.6">
                    <animate attributeName="y" values="25;50" dur="2s" begin="0.5s" repeatCount="indefinite" />
                    <animate attributeName="height" values="0;25" dur="2s" begin="0.5s" repeatCount="indefinite" />
                    <animate attributeName="opacity" values="0.6;0" dur="2s" begin="0.5s" repeatCount="indefinite" />
                </rect>

                <!-- Signal 3 Waterfall (Right) -->
                <rect x="160" y="25" width="8" height="25" fill="url(#fallGrad)" opacity="0.9">
                    <animate attributeName="y" values="25;50" dur="1.2s" begin="0.2s" repeatCount="indefinite" />
                    <animate attributeName="height" values="0;25" dur="1.2s" begin="0.2s" repeatCount="indefinite" />
                    <animate attributeName="opacity" values="0.9;0" dur="1.2s" begin="0.2s" repeatCount="indefinite" />
                </rect>

                <!-- Spectrum (Top) -->
                <!-- Base Noise Floor -->
                <polyline points="0,22 10,23 20,21 30,22 40,21 50,22 60,21 70,22 80,21 90,22 100,21 110,23 120,21 130,22 140,21 150,22 160,21 170,22 180,21 190,22 200,21" fill="none" stroke="#0ea5e9" stroke-width="1" opacity="0.5">
                     <animate attributeName="points" dur="0.2s" repeatCount="indefinite"
                        values="0,22 10,23 20,21 30,22 40,21 50,22 60,21 70,22 80,21 90,22 100,21 110,23 120,21 130,22 140,21 150,22 160,21 170,22 180,21 190,22 200,21;
                                0,21 10,22 20,23 30,21 40,22 50,21 60,22 70,21 80,22 90,21 100,22 110,21 120,22 130,23 140,22 150,21 160,22 170,21 180,22 190,21 200,22;
                                0,22 10,21 20,22 30,23 40,21 50,23 60,21 70,23 80,21 90,22 100,21 110,22 120,21 130,22 140,23 150,22 160,23 170,22 180,21 190,22 200,21" />
                </polyline>

                <!-- Active Signals Peaks -->
                <!-- Peak 1 at x=30 -->
                <path d="M25 22 L33 5 L41 22" fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                     <animate attributeName="d" dur="0.1s" repeatCount="indefinite"
                        values="M25 22 L33 5 L41 22; M25 22 L33 8 L41 22; M25 22 L33 4 L41 22" />
                </path>
                <!-- Peak 2 at x=110 -->
                <path d="M105 22 L112 12 L119 22" fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                     <animate attributeName="d" dur="0.15s" repeatCount="indefinite"
                        values="M105 22 L112 12 L119 22; M105 22 L112 15 L119 22; M105 22 L112 10 L119 22" />
                </path>
                <!-- Peak 3 at x=160 -->
                <path d="M152 22 L164 2 L176 22" fill="none" stroke="#e0f2fe" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                     <animate attributeName="d" dur="0.12s" repeatCount="indefinite"
                        values="M152 22 L164 2 L176 22; M152 22 L164 6 L176 22; M152 22 L164 3 L176 22" />
                </path>
            </svg>
            `;
            svgs.forEach(el => el.innerHTML = svgContent);
        }

        window.onload = () => {
            initSupabase();
            fetchLogs();
            renderSDRWidgets(); // Init visual widget
        };
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado!', reg))
                    .catch(err => console.log('Fallo al registrar SW', err));
            });
        }
    </script>

</body>

</html>
